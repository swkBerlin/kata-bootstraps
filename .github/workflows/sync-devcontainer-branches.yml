name: Sync devcontainer folders to per-folder branches

on:
  push:
    branches: [ master ] # change to main if needed
  workflow_dispatch:
    inputs:
      always_sync:
        description: "If true, push ALL <lang>/<framework> folders that contain .devcontainer (even if unchanged). If false, push only changed folders."
        required: false
        default: "false"

permissions:
  contents: write

env:
  # For workflow_dispatch you can set this input; for push it falls back to "false"
  ALWAYS_SYNC: ${{ github.event.inputs.always_sync || 'false' }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine folders to sync
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          REPO="$GITHUB_WORKSPACE"
          MODE="${ALWAYS_SYNC,,}"

          echo "Sync mode: ALWAYS_SYNC=$MODE"

          kept=()

          if [[ "$MODE" == "true" ]]; then
            # Sync ALL <lang>/<framework> dirs that have a .devcontainer (file or directory)
            while IFS= read -r d; do
              [[ -z "$d" ]] && continue
              # d like "./java/fitnesse" -> pair "java/fitnesse"
              pair="${d#./}"
              if [[ -e "$REPO/$pair/.devcontainer" ]]; then
                kept+=("$pair")
              fi
            done < <(find "$REPO" -mindepth 2 -maxdepth 2 -type d -not -path "*/.git/*" -printf "%P\n" | sort -u)

          else
            # Sync only changed <lang>/<framework> dirs that have a .devcontainer
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"

            # Edge case: first push
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              BEFORE="$(git -C "$REPO" rev-parse "$AFTER^" 2>/dev/null || true)"
            fi

            if [[ -z "${BEFORE:-}" ]]; then
              echo "No valid BEFORE commit; nothing to do."
              echo "pairs=" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            mapfile -t files < <(git -C "$REPO" diff --name-only "$BEFORE" "$AFTER" || true)

            pairs="$(printf "%s\n" "${files[@]}" \
              | awk -F/ 'NF>=2 {print $1"/"$2}' \
              | sort -u)"

            while IFS= read -r p; do
              [[ -z "$p" ]] && continue
              if [[ -e "$REPO/$p/.devcontainer" ]]; then
                kept+=("$p")
              fi
            done <<< "$pairs"
          fi

          # De-dupe (just in case), output newline list
          mapfile -t kept_sorted < <(printf "%s\n" "${kept[@]:-}" | sort -u)

          echo "Found folders with .devcontainer to sync:"
          if [[ ${#kept_sorted[@]} -eq 0 ]]; then
            echo " - (none)"
          else
            printf " - %s\n" "${kept_sorted[@]}"
          fi

          {
            echo "pairs<<EOF"
            printf "%s\n" "${kept_sorted[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Sync folders to <lang>-<framework> branches (single-commit branches)
        if: steps.detect.outputs.pairs != ''
        shell: bash
        run: |
          set -euo pipefail
          REPO="$GITHUB_WORKSPACE"
          cd "$REPO"

          git -C "$REPO" config user.name  "github-actions[bot]"
          git -C "$REPO" config user.email "github-actions[bot]@users.noreply.github.com"

          while IFS= read -r pair; do
            [[ -z "$pair" ]] && continue

            lang="${pair%%/*}"
            fw="${pair##*/}"
            branch="${lang}-${fw}"

            echo "----"
            echo "Syncing '$pair' -> branch '$branch'"

            # Stage source folder contents into /tmp/src
            rm -rf /tmp/src
            mkdir -p /tmp/src
            rsync -a "$REPO/$pair/" /tmp/src/

            # Create an orphan branch so the branch history is NOT preserved (single-commit branch)
            git -C "$REPO" checkout --orphan "$branch"

            # Clean working tree safely (keep git metadata)
            git -C "$REPO" rm -r --ignore-unmatch . >/dev/null 2>&1 || true
            git -C "$REPO" clean -fdx || true

            # Copy folder contents into branch root
            rsync -a /tmp/src/ "$REPO"/

            git -C "$REPO" add -A

            if git -C "$REPO" diff --cached --quiet; then
              echo "No changes to commit for '$branch' (skipping push)"
            else
              git -C "$REPO" commit -m "Sync ${pair} from master"
              git -C "$REPO" push --force -u origin "$branch"
              echo "Pushed branch '$branch'"
            fi

            git -C "$REPO" checkout master
          done <<< "${{ steps.detect.outputs.pairs }}"
